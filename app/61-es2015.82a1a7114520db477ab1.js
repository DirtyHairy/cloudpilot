(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{"6aA7":function(e,t,i){"use strict";i.r(t),i.d(t,"EmulationPageModule",function(){return H});var n=i("SVse"),s=i("iInd"),o=i("mrSG"),a=i("bucj"),r=i("z9fa");const c=a.b[2],l=a.b[0],h=a.b[6],u=3*devicePixelRatio,d=Math.round(1*u),v=160*u+2*d,b=252*u+2*d;function m(e){return new Promise((t,i)=>{const n=new Image;n.onload=()=>t(n),n.onerror=()=>i(),n.src=e})}const f=m("assets/silkscreen-default.svg"),g=m("assets/silkscreen-m515.svg");class p{constructor(e,t){this.canvas=e,this.emulationService=t;const i=e.getContext("2d");if(!i)throw new Error("get a new browser");this.ctx=i}clear(){return Object(o.a)(this,void 0,void 0,function*(){this.fillCanvasRect(0,0,v,b,this.backgroundColor()),yield this.drawSilkscreen(),this.drawButtons()})}drawSilkscreen(){return Object(o.a)(this,void 0,void 0,function*(){const e=yield this.silkscreenImage();this.fillRect(0,161,160,60,c),this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high",this.ctx.drawImage(e,d,d+161*u,160*u,60*u)})}drawButtons(e=[]){this.fillRect(0,222,160,30,this.backgroundColor()),e.includes(0)&&this.fillRect(0,222,30,30,h),e.includes(1)&&this.fillRect(30,222,30,30,h),e.includes(2)&&this.fillRect(100,222,30,30,h),e.includes(3)&&this.fillRect(130,222,30,30,h),e.includes(4)&&this.fillRect(60,222,40,15,h),e.includes(5)&&this.fillRect(60,237,40,15,h),this.ctx.beginPath(),this.ctx.lineWidth=Math.round(.5*u),this.ctx.strokeStyle=h,[[30,222,30,252],[60,222,60,252],[130,222,130,252],[100,222,100,252],[60,237,100,237]].forEach(([e,t,i,n])=>{this.ctx.moveTo(d+u*e,d+u*t),this.ctx.lineTo(d+u*i,d+u*n)}),this.ctx.stroke(),this.ctx.font=10*u+"px sans",this.ctx.fillStyle="black",this.textCenteredAt(15,237,"D"),this.textCenteredAt(45,237,"P"),this.textCenteredAt(115,237,"T"),this.textCenteredAt(145,237,"N")}drawEmulationCanvas(e){this.ctx.imageSmoothingEnabled=!1,this.ctx.drawImage(e,d,d,160*u,160*u)}fillRect(e,t,i,n,s){this.ctx.beginPath(),this.ctx.rect(d+u*e,d+u*t,u*i,u*n),this.ctx.fillStyle=s,this.ctx.fill()}fillCanvasRect(e,t,i,n,s){this.ctx.beginPath(),this.ctx.rect(e,t,i,n),this.ctx.fillStyle=s,this.ctx.fill()}textCenteredAt(e,t,i){const n=this.ctx.measureText(i);this.ctx.textBaseline="middle",this.ctx.fillText(i,d+u*e-n.width/2,d+u*t)}silkscreenImage(){var e;switch(null===(e=this.emulationService.getCurrentSession())||void 0===e?void 0:e.device){case r.a.m515:return g;default:return f}}backgroundColor(){var e;switch(null===(e=this.emulationService.getCurrentSession())||void 0===e?void 0:e.device){case r.a.m515:return"white";default:return l}}}var w=i("8Y7J"),S=i("sZkV");let M=(()=>{class e{constructor(e){this.emulationService=e,this.onClick=()=>{}}ngOnInit(){}reset(){this.emulationService.reset(),this.onClick()}resetNoExtensions(){this.emulationService.resetNoExtensions(),this.onClick()}resetHard(){this.emulationService.resetHard(),this.onClick()}}return e.\u0275fac=function(t){return new(t||e)(w.Jb(a.a))},e.\u0275cmp=w.Db({type:e,selectors:[["app-emulation-context-menu"]],inputs:{onClick:"onClick"},decls:7,vars:6,consts:[["button","",3,"detail","disabled","click"]],template:function(e,t){1&e&&(w.Mb(0,"ion-list"),w.Mb(1,"ion-item",0),w.Ub("click",function(){return t.reset()}),w.gc(2," Reset "),w.Lb(),w.Mb(3,"ion-item",0),w.Ub("click",function(){return t.resetNoExtensions()}),w.gc(4," Reset (no extensions) "),w.Lb(),w.Mb(5,"ion-item",0),w.Ub("click",function(){return t.resetHard()}),w.gc(6," Hard reset "),w.Lb(),w.Lb()),2&e&&(w.zb(1),w.Zb("detail",!1)("disabled",!t.emulationService.isRunning()),w.zb(2),w.Zb("detail",!1)("disabled",!t.emulationService.isRunning()),w.zb(2),w.Zb("detail",!1)("disabled",!t.emulationService.isRunning()))},directives:[S.m,S.h],styles:[""]}),e})();class x{constructor(e,t,i){this.canvas=e,this.emulationService=t,this.canvasHelper=i,this.handleMouseDown=e=>{if(0!==e.button)return;const t=this.eventToPalmCoordinates(e);if(!t)return;const i=this.determineArea(t);if(0===i)this.interactionMouse={area:i},this.emulationService.handlePointerMove(...t);else{const e=this.determineButton(t);this.interactionMouse={area:i,button:e},this.emulationService.handleButtonDown(e),this.canvasHelper.drawButtons(this.activeButtons())}},this.handleMouseMove=e=>{var t;if(!(1&e.buttons)||0!==(null===(t=this.interactionMouse)||void 0===t?void 0:t.area))return;const i=this.eventToPalmCoordinates(e,!0);i&&this.emulationService.handlePointerMove(...i)},this.handeMouseUp=e=>{if(0!==e.button)return;const t=this.interactionMouse;switch(this.interactionMouse=void 0,null==t?void 0:t.area){case 1:this.emulationService.handleButtonUp(t.button),this.canvasHelper.drawButtons(this.activeButtons());break;case 0:this.emulationService.handlePointerUp()}},this.handleTouchStart=e=>{for(let t=0;t<e.changedTouches.length;t++){const i=e.changedTouches.item(t);if(!i)continue;const n=this.eventToPalmCoordinates(i);if(!n)continue;const s=this.determineArea(n);if(0===s)this.interactionsTouch.set(i.identifier,{area:s}),this.emulationService.handlePointerMove(...n);else{const e=this.determineButton(n);this.interactionsTouch.set(i.identifier,{area:s,button:e}),this.emulationService.handleButtonDown(e),this.canvasHelper.drawButtons(this.activeButtons())}}!1!==e.cancelable&&e.preventDefault()},this.handleTouchMove=e=>{var t;for(let i=0;i<e.changedTouches.length;i++){const n=e.changedTouches.item(i);if(n&&0===(null===(t=this.interactionsTouch.get(n.identifier))||void 0===t?void 0:t.area)){const e=this.eventToPalmCoordinates(n,!0);if(!e)continue;this.emulationService.handlePointerMove(...e)}}!1!==e.cancelable&&e.preventDefault()},this.handleTouchEnd=e=>{for(let t=0;t<e.changedTouches.length;t++){const i=e.changedTouches.item(t);if(!i)continue;const n=this.interactionsTouch.get(i.identifier);switch(this.interactionsTouch.delete(i.identifier),null==n?void 0:n.area){case 1:this.emulationService.handleButtonUp(n.button),this.canvasHelper.drawButtons(this.activeButtons());break;case 0:this.emulationService.handlePointerUp()}}!1!==e.cancelable&&e.preventDefault()},this.interactionsTouch=new Map,this.bound=!1}bind(){this.bound||(this.canvas.addEventListener("mousedown",this.handleMouseDown),window.addEventListener("mouseup",this.handeMouseUp),window.addEventListener("mousemove",this.handleMouseMove),this.canvas.addEventListener("touchstart",this.handleTouchStart),this.canvas.addEventListener("touchmove",this.handleTouchMove),this.canvas.addEventListener("touchend",this.handleTouchEnd),this.canvas.addEventListener("touchcancel",this.handleTouchEnd),this.bound=!0)}release(){this.bound&&(this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mouseup",this.handeMouseUp),window.removeEventListener("mousemove",this.handleMouseMove),this.canvas.removeEventListener("touchstart",this.handleTouchStart),this.canvas.removeEventListener("touchmove",this.handleTouchMove),this.canvas.removeEventListener("touchend",this.handleTouchEnd),this.canvas.removeEventListener("touchcancel",this.handleTouchEnd),this.bound=!1)}eventToPalmCoordinates(e,t=!1){const i=this.canvas.getBoundingClientRect();let n,s,o,a;i.width/i.height>v/b?(a=i.height,o=v/b*i.height,s=i.top,n=i.left+(i.width-o)/2):(o=i.width,a=b/v*i.width,n=i.left,s=i.top+(i.height-a)/2);let r=Math.floor((e.clientX-n)/o*v/u)-d/u,c=Math.floor((e.clientY-s)/a*b/u)-d/u;if(c>=222?c-=2:c>=161&&(c-=1),t)r<0&&(r=0),r>159&&(r=159),c<0&&(c=0),c>249&&(c=249);else if(r<0||r>=160||c<0||c>=250)return;return[r,c]}determineArea([,e]){return e>=220?1:0}determineButton([e,t]){return e>=130?3:e>=100?2:e>=60?t>=236?5:4:e>=30?1:0}activeButtons(){var e;const t=Array.from(this.interactionsTouch.values()).filter(e=>1===e.area).map(e=>e.button);return 1===(null===(e=this.interactionMouse)||void 0===e?void 0:e.area)&&t.push(this.interactionMouse.button),t}}var C=i("hq03"),k=i("shLW");const L=["canvas"];function T(e,t){1&e&&(w.Mb(0,"div",13),w.Mb(1,"div"),w.gc(2,"No session selected"),w.Lb(),w.Lb())}const E=[{path:"",component:(()=>{class e{constructor(e,t,i,n,s,o){this.emulationService=e,this.popoverController=t,this.alertService=i,this.fileService=n,this.loadingController=s,this.ngZone=o,this.onNewFrame=e=>{this.canvasHelper.drawEmulationCanvas(e)}}ngAfterViewInit(){const e=this.canvasRef.nativeElement;this.canvasHelper=new p(e,this.emulationService),this.eventHandler=new x(e,this.emulationService,this.canvasHelper),this.canvasHelper.clear()}get canvasWidth(){return v}get canvasHeight(){return b}get cssWidth(){return this.canvasWidth/devicePixelRatio+"px"}get cssHeight(){return this.canvasHeight/devicePixelRatio+"px"}powerButtonDown(){return Object(o.a)(this,void 0,void 0,function*(){this.emulationService.handleButtonDown(6)})}powerButtonUp(){return Object(o.a)(this,void 0,void 0,function*(){this.emulationService.handleButtonUp(6)})}ionViewDidEnter(){var e,t;return Object(o.a)(this,void 0,void 0,function*(){this.currentSession!==(null===(e=this.emulationService.getCurrentSession())||void 0===e?void 0:e.id)&&(yield this.canvasHelper.clear()),this.currentSession=null===(t=this.emulationService.getCurrentSession())||void 0===t?void 0:t.id,this.emulationService.newFrame.addHandler(this.onNewFrame),this.emulationService.resume(),this.ngZone.runOutsideAngular(()=>this.eventHandler.bind())})}ionViewWillLeave(){this.emulationService.pause(),this.emulationService.newFrame.removeHandler(this.onNewFrame),this.eventHandler.release()}openContextMenu(e){return Object(o.a)(this,void 0,void 0,function*(){const t=yield this.popoverController.create({component:M,event:e,backdropDismiss:!0,showBackdrop:!1,componentProps:{onClick:()=>t.dismiss()}});t.present()})}installFiles(){this.fileService.openFiles(this.processFilesForInstallation.bind(this))}get installFileDisabled(){return!this.emulationService.isRunning()||this.emulationService.isPowerOff()||!this.emulationService.isUiInitialized()}get title(){var e;return(null===(e=this.emulationService.getCurrentSession())||void 0===e?void 0:e.name)||"Emulation"}processFilesForInstallation(e){return Object(o.a)(this,void 0,void 0,function*(){const t=yield this.loadingController.create({message:"Installing..."});yield t.present();const i=[],n=[];try{for(const t of e)/\.(prc|pdb)$/i.test(t.name)&&0==(yield this.emulationService.installFile(t.content))?i.push(t.name):n.push(t.name)}finally{t.dismiss()}let s,o;switch(i.length){case 0:s="";break;case 1:s=`Installation of ${i[0]} successful.`;break;default:s=`Installation of ${i.length} files successful.`}switch(n.length>0&&(s+="<br/><br/>"),n.length){case 0:break;case 1:s+=`Installation of ${n[0]} failed.`;break;default:s+=`Installation of ${n.slice(0,n.length>3?3:n.length-1).join(", ")} and ${n.length>3?n.length-3+" more files":n[n.length-1]} failed.`}o=0===n.length?"Installation successful":0===i.length?"Installation failed":"Installation errors",this.alertService.message(o,s)})}}return e.\u0275fac=function(t){return new(t||e)(w.Jb(a.a),w.Jb(S.w),w.Jb(C.a),w.Jb(k.a),w.Jb(S.v),w.Jb(w.B))},e.\u0275cmp=w.Db({type:e,selectors:[["app-emulation"]],viewQuery:function(e,t){if(1&e&&w.kc(L,1),2&e){let e;w.ac(e=w.Vb())&&(t.canvasRef=e.first)}},decls:19,vars:14,consts:[["slot","end"],[3,"disabled","mousedown","mouseup"],["name","power-outline"],[3,"disabled","click"],["name","add-outline"],["slot","start"],[3,"click"],["name","ellipsis-vertical-outline"],["name","checkmark-circle-outline"],[1,"container","running-session"],[3,"width","height"],["canvas",""],["class","container no-session",4,"ngIf"],[1,"container","no-session"]],template:function(e,t){1&e&&(w.Mb(0,"ion-header"),w.Mb(1,"ion-toolbar"),w.Mb(2,"ion-title"),w.gc(3),w.Lb(),w.Mb(4,"ion-buttons",0),w.Mb(5,"ion-button",1),w.Ub("mousedown",function(){return t.powerButtonDown()})("mouseup",function(){return t.powerButtonUp()}),w.Kb(6,"ion-icon",2),w.Lb(),w.Mb(7,"ion-button",3),w.Ub("click",function(){return t.installFiles()}),w.Kb(8,"ion-icon",4),w.Lb(),w.Lb(),w.Mb(9,"ion-buttons",5),w.Mb(10,"ion-button",6),w.Ub("click",function(e){return t.openContextMenu(e)}),w.Kb(11,"ion-icon",7),w.Lb(),w.Mb(12,"ion-button"),w.Kb(13,"ion-icon",8),w.Lb(),w.Lb(),w.Lb(),w.Lb(),w.Mb(14,"ion-content"),w.Mb(15,"div",9),w.Kb(16,"canvas",10,11),w.Lb(),w.fc(18,T,3,0,"div",12),w.Lb()),2&e&&(w.zb(3),w.hc(t.title),w.zb(2),w.Zb("disabled",!t.emulationService.isRunning()),w.zb(2),w.Zb("disabled",t.installFileDisabled),w.zb(8),w.ec("display",t.emulationService.getCurrentSession()?void 0:"none"),w.zb(1),w.ec("width",t.cssWidth)("height",t.cssHeight)("display",t.emulationService.getCurrentSession()?"block":"none"),w.Zb("width",t.canvasWidth)("height",t.canvasHeight),w.zb(2),w.Zb("ngIf",!t.emulationService.getCurrentSession()))},directives:[S.f,S.s,S.r,S.d,S.c,S.g,S.e,n.i],styles:["ion-title[_ngcontent-%COMP%]{text-align:center}.container[_ngcontent-%COMP%]{width:100%;height:100%;display:flex;justify-content:center;align-items:center;padding:3px}@media (prefers-color-scheme:light){.container.running-session[_ngcontent-%COMP%]{background:#a8a8a8}}canvas[_ngcontent-%COMP%]{max-width:100%;max-height:100%;-o-object-fit:contain;object-fit:contain}"]}),e})()}];let y=(()=>{class e{}return e.\u0275mod=w.Hb({type:e}),e.\u0275inj=w.Gb({factory:function(t){return new(t||e)},imports:[[s.i.forChild(E)],s.i]}),e})();var B=i("s7LF");let H=(()=>{class e{}return e.\u0275mod=w.Hb({type:e}),e.\u0275inj=w.Gb({factory:function(t){return new(t||e)},imports:[[n.b,B.a,S.t,y]]}),e})()}}]);