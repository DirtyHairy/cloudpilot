!function(){function e(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function n(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function t(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{"/NlI":function(n,r,i){"use strict";i.r(r),i.d(r,"SessionsPageModule",function(){return C});var o,s=i("SVse"),a=i("s7LF"),c=i("sZkV"),u=i("iInd"),l=i("mrSG"),d=i("8Y7J"),m=i("bucj"),f=i("xOb2"),b=((o=function(){function n(t,r){e(this,n),this.emulationService=t,this.storageService=r,this.sessions=[],this.updateSessionsFromStorage()}return t(n,[{key:"addSessionFromImage",value:function(e,n){return Object(l.a)(this,void 0,void 0,regeneratorRuntime.mark(function t(){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r={id:-1,name:n,device:e.deviceId,ram:e.memory.length/1024/1024,rom:""},t.next=3,this.storageService.addSession(r,e.rom);case 3:this.updateSessionsFromStorage();case 4:case"end":return t.stop()}},t,this)}))}},{key:"addSessionFromRom",value:function(e,n,t){return Object(l.a)(this,void 0,void 0,regeneratorRuntime.mark(function r(){var i;return regeneratorRuntime.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.t0=-1,r.t1=n,r.t2=t,r.next=5,this.emulationService.cloudpilot;case 5:return r.t3=r.sent.minRamForDevice(t),r.t4=r.t3/1024,r.t5=r.t4/1024,i={id:r.t0,name:r.t1,device:r.t2,ram:r.t5,rom:""},r.next=11,this.storageService.addSession(i,e);case 11:this.updateSessionsFromStorage();case 12:case"end":return r.stop()}},r,this)}))}},{key:"getSessions",value:function(){return this.sessions}},{key:"deleteSession",value:function(e){return Object(l.a)(this,void 0,void 0,regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.storageService.deleteSession(e);case 2:this.updateSessionsFromStorage();case 3:case"end":return n.stop()}},n,this)}))}},{key:"updateSession",value:function(e){return Object(l.a)(this,void 0,void 0,regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.storageService.updateSession(e);case 2:this.updateSessionsFromStorage();case 3:case"end":return n.stop()}},n,this)}))}},{key:"updateSessionsFromStorage",value:function(){return Object(l.a)(this,void 0,void 0,regeneratorRuntime.mark(function e(){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getAllSessions();case 2:this.sessions=e.sent.sort(function(e,n){return e.name.localeCompare(n.name)});case 3:case"end":return e.stop()}},e,this)}))}}]),n}()).\u0275fac=function(e){return new(e||o)(d.Qb(m.a),d.Qb(f.a))},o.\u0275prov=d.Fb({token:o,factory:o.\u0275fac,providedIn:"root"}),o);function v(e,n){return e[n]|e[n+1]<<8|e[n+2]<<16|e[n+3]<<24}var p,h,g=((h=function(){function n(){e(this,n)}return t(n,[{key:"openFile",value:function(e,n){var t=this,r=document.createElement("input");r.type="file",r.onchange=function(r){return Object(l.a)(t,void 0,void 0,regeneratorRuntime.mark(function t(){var i,o,s,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(o=r.target,null===(i=null==o?void 0:o.files)||void 0===i?void 0:i.length){t.next=3;break}return t.abrupt("return");case 3:if(s=o.files.item(0)){t.next=6;break}return t.abrupt("return");case 6:if(e.replace(/\s+/g,"").split(",").some(function(e){return s.name.endsWith(e)})){t.next=8;break}return t.abrupt("return");case 8:return t.next=10,new Promise(function(e,n){var t=new FileReader;t.onload=function(){return e(new Uint8Array(t.result))},t.onerror=function(){return n(t.error)},t.readAsArrayBuffer(s)});case 10:a=t.sent,n({name:s.name,content:a});case 12:case"end":return t.stop()}},t)}))},r.click()}},{key:"parseSessionImage",value:function(e){if(!(e.length<16)&&538247427===v(e,0)){if(0==(-2147483648&v(e,4)))return this.parseSessionImageLegacy(e);if(-2147483647===v(e,4)&&!(e.length<28)){var n=v(e,8),t=v(e,12),r=v(e,16),i=v(e,20);if(28+n+t+r+i+v(e,24)===e.length){var o;try{o=JSON.parse((new TextDecoder).decode(e.subarray(28+n,28+n+t)))}catch(s){console.warn("metadata is not valid JSON")}return{metadata:o,deviceId:(new TextDecoder).decode(e.subarray(28,28+n)),rom:e.subarray(28+n+t,28+n+t+r),memory:e.subarray(28+n+t+r,28+n+t+r+i),savestate:e.subarray(28+n+t+r+i)}}}}}},{key:"parseSessionImageLegacy",value:function(e){var n=v(e,4),t=v(e,8);if(n+t+v(e,12)+16===e.length)return{deviceId:"PalmV",rom:e.subarray(16+n,16+n+t),memory:e.subarray(16+n+t),savestate:new Uint8Array(0)}}}]),n}()).\u0275fac=function(e){return new(e||h)},h.\u0275prov=d.Fb({token:h,factory:h.\u0275fac,providedIn:"root"}),h),S=((p=function(){function n(){e(this,n),this.onEdit=function(){},this.onSave=function(){},this.onDelete=function(){}}return t(n,[{key:"ngOnInit",value:function(){}}]),n}()).\u0275fac=function(e){return new(e||p)},p.\u0275cmp=d.Db({type:p,selectors:[["app-session-context-menu"]],inputs:{onEdit:"onEdit",onSave:"onSave",onDelete:"onDelete"},decls:10,vars:3,consts:[["button","",3,"detail","click"],["name","create-outline","slot","end"],["name","download-outline","slot","end"],["name","trash-outline","slot","end"]],template:function(e,n){1&e&&(d.Mb(0,"ion-list"),d.Mb(1,"ion-item",0),d.Ub("click",function(){return n.onEdit()}),d.fc(2," Edit "),d.Kb(3,"ion-icon",1),d.Lb(),d.Mb(4,"ion-item",0),d.Ub("click",function(){return n.onSave()}),d.fc(5," Save "),d.Kb(6,"ion-icon",2),d.Lb(),d.Mb(7,"ion-item",0),d.Ub("click",function(){return n.onDelete()}),d.fc(8," Delete "),d.Kb(9,"ion-icon",3),d.Lb(),d.Lb()),2&e&&(d.zb(1),d.Zb("detail",!1),d.zb(3),d.Zb("detail",!1),d.zb(3),d.Zb("detail",!1))},directives:[c.m,c.h,c.g],styles:[""]}),p),y=i("z9fa");function k(e,n){if(1&e&&(d.Mb(0,"span"),d.fc(1),d.Lb()),2&e){var t=d.Wb();d.zb(1),d.hc(", OS ",null==t.session?null:t.session.osVersion,"")}}var w,x=((w=function(){function n(t){e(this,n),this.popoverController=t,this.selected=!1,this.delete=new d.o,this.edit=new d.o,this.save=new d.o,this.selectItem=new d.o}return t(n,[{key:"device",get:function(){var e;switch(null===(e=this.session)||void 0===e?void 0:e.device){case y.a.m515:return"Palm m515";case y.a.palmV:return"Palm V";default:throw new Error("bad device ID")}}},{key:"onContextmenu",value:function(e){return Object(l.a)(this,void 0,void 0,regeneratorRuntime.mark(function n(){var t,r=this;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return e.stopPropagation(),e.preventDefault(),n.next=3,this.popoverController.create({component:S,event:e,backdropDismiss:!0,showBackdrop:!1,componentProps:{onEdit:function(){t.dismiss(),r.edit.emit()},onSave:function(){t.dismiss(),r.save.emit()},onDelete:function(){t.dismiss(),r.delete.emit()}}});case 3:(t=n.sent).present();case 5:case"end":return n.stop()}},n,this)}))}}]),n}()).\u0275fac=function(e){return new(e||w)(d.Jb(c.v))},w.\u0275cmp=d.Db({type:w,selectors:[["app-session-item"]],inputs:{session:"session",selected:"selected"},outputs:{delete:"delete",edit:"edit",save:"save",selectItem:"selectItem"},decls:16,vars:5,consts:[[3,"contextmenu"],["side","start"],["color","primary","icon-only","",3,"click"],["name","create-outline"],["color","secondary","icon-only","",3,"click"],["name","download-outline"],["side","end"],["color","danger","icon-only","",3,"click"],["name","trash-outline"],[3,"color","click"],[4,"ngIf"]],template:function(e,n){1&e&&(d.Mb(0,"ion-item-sliding",0),d.Ub("contextmenu",function(e){return n.onContextmenu(e)}),d.Mb(1,"ion-item-options",1),d.Mb(2,"ion-item-option",2),d.Ub("click",function(){return n.edit.emit(n.session)}),d.Kb(3,"ion-icon",3),d.Lb(),d.Mb(4,"ion-item-option",4),d.Ub("click",function(){return n.save.emit(n.session)}),d.Kb(5,"ion-icon",5),d.Lb(),d.Lb(),d.Mb(6,"ion-item-options",6),d.Mb(7,"ion-item-option",7),d.Ub("click",function(){return n.delete.emit(n.session)}),d.Kb(8,"ion-icon",8),d.Lb(),d.Lb(),d.Mb(9,"ion-item",9),d.Ub("click",function(){return n.selectItem.emit()}),d.Mb(10,"ion-label"),d.Mb(11,"h2"),d.fc(12),d.Lb(),d.Mb(13,"p"),d.fc(14),d.ec(15,k,2,1,"span",10),d.Lb(),d.Lb(),d.Lb(),d.Lb()),2&e&&(d.zb(9),d.Zb("color",n.selected?"primary":void 0),d.zb(3),d.gc(null==n.session?null:n.session.name),d.zb(2),d.ic("",n.device," ",null==n.session?null:n.session.ram,"MB RAM"),d.zb(1),d.Zb("ngIf",null==n.session?null:n.session.osVersion))},directives:[c.k,c.j,c.i,c.g,c.h,c.l,s.i],styles:["ion-label[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%], p[_ngcontent-%COMP%]{margin-top:.75em}ion-item-option[_ngcontent-%COMP%]{font-size:1.5em}ion-item-sliding[_ngcontent-%COMP%]{cursor:pointer}"]}),w);function M(e,n){if(1&e){var t=d.Nb();d.Mb(0,"app-session-item",6),d.Ub("delete",function(){d.bc(t);var e=n.$implicit;return d.Wb().deleteSession(e)})("selectItem",function(){d.bc(t);var e=n.$implicit;return d.Wb().launchSession(e)})("edit",function(){d.bc(t);var e=n.$implicit;return d.Wb().editSession(e)}),d.Lb()}if(2&e){var r,i=n.$implicit,o=d.Wb();d.Zb("session",i)("selected",(null==(r=o.emulationService.getCurrentSession())?null:r.id)===i.id)}}var R,L,O,I=[{path:"",component:(R=function(){function n(t,r,i,o,s){e(this,n),this.sessionService=t,this.fileService=r,this.alertController=i,this.emulationService=o,this.router=s}return t(n,[{key:"sessions",get:function(){return this.sessionService.getSessions().sort(function(e,n){return e.name.localeCompare(n.name)})}},{key:"deleteSession",value:function(e){return Object(l.a)(this,void 0,void 0,regeneratorRuntime.mark(function n(){var t,r=this;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.alertController.create({header:"Warning",message:"Deleting the session '".concat(e.name,"' will remove all associated data. This cannot be undone. Are you sure you want to continue?"),buttons:[{text:"Cancel",role:"cancel"},{text:"Delete",handler:function(){return r.sessionService.deleteSession(e)}}]});case 2:return t=n.sent,n.next=5,t.present();case 5:case"end":return n.stop()}},n,this)}))}},{key:"editSession",value:function(e){return Object(l.a)(this,void 0,void 0,regeneratorRuntime.mark(function n(){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.queryName(e.name);case 2:void 0!==(t=n.sent)&&this.sessionService.updateSession(Object.assign(Object.assign({},e),{name:t}));case 4:case"end":return n.stop()}},n,this)}))}},{key:"loadFile",value:function(){this.fileService.openFile(".img, .rom, .bin",this.processFile.bind(this))}},{key:"launchSession",value:function(e){this.emulationService.switchSession(e.id),this.router.navigateByUrl("/tab/emulation")}},{key:"processFile",value:function(e){return Object(l.a)(this,void 0,void 0,regeneratorRuntime.mark(function n(){var t,r,i,o;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!(t=this.fileService.parseSessionImage(e.content))){n.next=8;break}return n.next=4,this.queryName(e.name);case 4:void 0!==(r=n.sent)&&this.sessionService.addSessionFromImage(t,r),n.next=19;break;case 8:return n.next=10,this.emulationService.cloudpilot;case 10:if(i=n.sent.getRomInfo(e.content)){n.next=13;break}return n.abrupt("return",void this.errorMessage("Not a valid session file or ROM image."));case 13:if(0!==i.supportedDevices.length){n.next=15;break}return n.abrupt("return",void this.errorMessage("No supported device for this ROM."));case 15:return n.next=17,this.queryName(e.name);case 17:void 0!==(o=n.sent)&&this.sessionService.addSessionFromRom(e.content,o,i.supportedDevices[0]);case 19:case"end":return n.stop()}},n,this)}))}},{key:"queryName",value:function(e){var n=this;return new Promise(function(t){return Object(l.a)(n,void 0,void 0,regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.alertController.create({header:"Session Name",inputs:[{type:"textarea",name:"name",placeholder:"Session name",value:e,label:"Name"}],buttons:[{text:"Cancel",role:"cancel",handler:function(){return t(void 0)}},{text:"Continue",handler:function(e){return t(e.name)}}]});case 2:n.sent.present();case 3:case"end":return n.stop()}},n,this)}))})}},{key:"errorMessage",value:function(e){return Object(l.a)(this,void 0,void 0,regeneratorRuntime.mark(function n(){var t;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.alertController.create({header:"Error",message:e,buttons:[{text:"Close",role:"cancel"}]});case 2:return t=n.sent,n.next=5,t.present();case 5:case"end":return n.stop()}},n,this)}))}}]),n}(),R.\u0275fac=function(e){return new(e||R)(d.Jb(b),d.Jb(g),d.Jb(c.a),d.Jb(m.a),d.Jb(u.g))},R.\u0275cmp=d.Db({type:R,selectors:[["app-sessions"]],decls:14,vars:1,consts:[["slot","primary"],[3,"click"],["name","add-outline"],["collapse","condense"],["size","large"],[3,"session","selected","delete","selectItem","edit",4,"ngFor","ngForOf"],[3,"session","selected","delete","selectItem","edit"]],template:function(e,n){1&e&&(d.Mb(0,"ion-header"),d.Mb(1,"ion-toolbar"),d.Mb(2,"ion-title"),d.fc(3,"Sessions"),d.Lb(),d.Mb(4,"ion-buttons",0),d.Mb(5,"ion-button",1),d.Ub("click",function(){return n.loadFile()}),d.Kb(6,"ion-icon",2),d.Lb(),d.Lb(),d.Lb(),d.Lb(),d.Mb(7,"ion-content"),d.Mb(8,"ion-header",3),d.Mb(9,"ion-toolbar"),d.Mb(10,"ion-title",4),d.fc(11,"Sessions"),d.Lb(),d.Lb(),d.Lb(),d.Mb(12,"ion-list"),d.ec(13,M,1,2,"app-session-item",5),d.Lb(),d.Lb()),2&e&&(d.zb(13),d.Zb("ngForOf",n.sessions))},directives:[c.f,c.s,c.r,c.d,c.c,c.g,c.e,c.m,s.h,x],styles:[""]}),R)}],F=((O=function n(){e(this,n)}).\u0275mod=d.Hb({type:O}),O.\u0275inj=d.Gb({factory:function(e){return new(e||O)},imports:[[u.i.forChild(I)],u.i]}),O),C=((L=function n(){e(this,n)}).\u0275mod=d.Hb({type:L}),L.\u0275inj=d.Gb({factory:function(e){return new(e||L)},imports:[[s.b,a.a,c.t,F]]}),L)}}])}();