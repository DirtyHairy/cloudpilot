(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{"/NlI":function(e,t,n){"use strict";n.r(t),n.d(t,"SessionsPageModule",function(){return M});var i=n("SVse"),s=n("s7LF"),o=n("sZkV"),r=n("iInd"),c=n("mrSG"),a=n("8Y7J"),l=n("bucj"),d=n("xOb2");let u=(()=>{class e{constructor(e,t){this.emulationService=e,this.storageService=t,this.sessions=[],this.updateSessionsFromStorage()}addSessionFromImage(e,t){return Object(c.a)(this,void 0,void 0,function*(){const n={id:-1,name:t,device:e.deviceId,ram:e.memory.length/1024/1024,rom:""};yield this.storageService.addSession(n,e.rom),this.updateSessionsFromStorage()})}addSessionFromRom(e,t,n){return Object(c.a)(this,void 0,void 0,function*(){const i={id:-1,name:t,device:n,ram:(yield this.emulationService.cloudpilot).minRamForDevice(n)/1024/1024,rom:""};yield this.storageService.addSession(i,e),this.updateSessionsFromStorage()})}getSessions(){return this.sessions}deleteSession(e){return Object(c.a)(this,void 0,void 0,function*(){yield this.storageService.deleteSession(e),this.updateSessionsFromStorage()})}updateSession(e){return Object(c.a)(this,void 0,void 0,function*(){yield this.storageService.updateSession(e),this.updateSessionsFromStorage()})}updateSessionsFromStorage(){return Object(c.a)(this,void 0,void 0,function*(){this.sessions=(yield this.storageService.getAllSessions()).sort((e,t)=>e.name.localeCompare(t.name))})}}return e.\u0275fac=function(t){return new(t||e)(a.Qb(l.a),a.Qb(d.a))},e.\u0275prov=a.Fb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();function m(e,t){return e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24}let b=(()=>{class e{openFile(e,t){const n=document.createElement("input");n.type="file",n.onchange=n=>Object(c.a)(this,void 0,void 0,function*(){var i;const s=n.target;if(!(null===(i=null==s?void 0:s.files)||void 0===i?void 0:i.length))return;const o=s.files.item(0);if(!o)return;if(!e.replace(/\s+/g,"").split(",").some(e=>o.name.endsWith(e)))return;const r=yield new Promise((e,t)=>{const n=new FileReader;n.onload=()=>e(new Uint8Array(n.result)),n.onerror=()=>t(n.error),n.readAsArrayBuffer(o)});t({name:o.name,content:r})}),n.click()}parseSessionImage(e){if(e.length<16)return;if(538247427!==m(e,0))return;if(0==(-2147483648&m(e,4)))return this.parseSessionImageLegacy(e);if(-2147483647!==m(e,4))return;if(e.length<28)return;const t=m(e,8),n=m(e,12),i=m(e,16),s=m(e,20);if(28+t+n+i+s+m(e,24)!==e.length)return;let o;try{o=JSON.parse((new TextDecoder).decode(e.subarray(28+t,28+t+n)))}catch(r){console.warn("metadata is not valid JSON")}return{metadata:o,deviceId:(new TextDecoder).decode(e.subarray(28,28+t)),rom:e.subarray(28+t+n,28+t+n+i),memory:e.subarray(28+t+n+i,28+t+n+i+s),savestate:e.subarray(28+t+n+i+s)}}parseSessionImageLegacy(e){const t=m(e,4),n=m(e,8);if(t+n+m(e,12)+16===e.length)return{deviceId:"PalmV",rom:e.subarray(16+t,16+t+n),memory:e.subarray(16+t+n),savestate:new Uint8Array(0)}}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275prov=a.Fb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})(),p=(()=>{class e{constructor(){this.onEdit=()=>{},this.onSave=()=>{},this.onDelete=()=>{}}ngOnInit(){}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275cmp=a.Db({type:e,selectors:[["app-context-menu"]],inputs:{onEdit:"onEdit",onSave:"onSave",onDelete:"onDelete"},decls:10,vars:3,consts:[["button","",3,"detail","click"],["name","create-outline","slot","end"],["name","download-outline","slot","end"],["name","trash-outline","slot","end"]],template:function(e,t){1&e&&(a.Mb(0,"ion-list"),a.Mb(1,"ion-item",0),a.Ub("click",function(){return t.onEdit()}),a.fc(2," Edit "),a.Kb(3,"ion-icon",1),a.Lb(),a.Mb(4,"ion-item",0),a.Ub("click",function(){return t.onSave()}),a.fc(5," Save "),a.Kb(6,"ion-icon",2),a.Lb(),a.Mb(7,"ion-item",0),a.Ub("click",function(){return t.onDelete()}),a.fc(8," Delete "),a.Kb(9,"ion-icon",3),a.Lb(),a.Lb()),2&e&&(a.zb(1),a.Zb("detail",!1),a.zb(3),a.Zb("detail",!1),a.zb(3),a.Zb("detail",!1))},directives:[o.m,o.h,o.g],styles:[""]}),e})();var h=n("z9fa");function v(e,t){if(1&e&&(a.Mb(0,"span"),a.fc(1),a.Lb()),2&e){const e=a.Wb();a.zb(1),a.hc(", OS ",null==e.session?null:e.session.osVersion,"")}}let f=(()=>{class e{constructor(e){this.popoverController=e,this.selected=!1,this.delete=new a.o,this.edit=new a.o,this.save=new a.o,this.selectItem=new a.o}get device(){var e;switch(null===(e=this.session)||void 0===e?void 0:e.device){case h.a.m515:return"Palm m515";case h.a.palmV:return"Palm V";default:throw new Error("bad device ID")}}onContextmenu(e){return Object(c.a)(this,void 0,void 0,function*(){e.stopPropagation(),e.preventDefault();const t=yield this.popoverController.create({component:p,event:e,backdropDismiss:!0,showBackdrop:!1,componentProps:{onEdit:()=>{t.dismiss(),this.edit.emit()},onSave:()=>{t.dismiss(),this.save.emit()},onDelete:()=>{t.dismiss(),this.delete.emit()}}});t.present()})}}return e.\u0275fac=function(t){return new(t||e)(a.Jb(o.v))},e.\u0275cmp=a.Db({type:e,selectors:[["app-session-item"]],inputs:{session:"session",selected:"selected"},outputs:{delete:"delete",edit:"edit",save:"save",selectItem:"selectItem"},decls:16,vars:5,consts:[[3,"contextmenu"],["side","start"],["color","primary","icon-only","",3,"click"],["name","create-outline"],["color","secondary","icon-only","",3,"click"],["name","download-outline"],["side","end"],["color","danger","icon-only","",3,"click"],["name","trash-outline"],[3,"color","click"],[4,"ngIf"]],template:function(e,t){1&e&&(a.Mb(0,"ion-item-sliding",0),a.Ub("contextmenu",function(e){return t.onContextmenu(e)}),a.Mb(1,"ion-item-options",1),a.Mb(2,"ion-item-option",2),a.Ub("click",function(){return t.edit.emit(t.session)}),a.Kb(3,"ion-icon",3),a.Lb(),a.Mb(4,"ion-item-option",4),a.Ub("click",function(){return t.save.emit(t.session)}),a.Kb(5,"ion-icon",5),a.Lb(),a.Lb(),a.Mb(6,"ion-item-options",6),a.Mb(7,"ion-item-option",7),a.Ub("click",function(){return t.delete.emit(t.session)}),a.Kb(8,"ion-icon",8),a.Lb(),a.Lb(),a.Mb(9,"ion-item",9),a.Ub("click",function(){return t.selectItem.emit()}),a.Mb(10,"ion-label"),a.Mb(11,"h2"),a.fc(12),a.Lb(),a.Mb(13,"p"),a.fc(14),a.ec(15,v,2,1,"span",10),a.Lb(),a.Lb(),a.Lb(),a.Lb()),2&e&&(a.zb(9),a.Zb("color",t.selected?"primary":void 0),a.zb(3),a.gc(null==t.session?null:t.session.name),a.zb(2),a.ic("",t.device," ",null==t.session?null:t.session.ram,"MB RAM"),a.zb(1),a.Zb("ngIf",null==t.session?null:t.session.osVersion))},directives:[o.k,o.j,o.i,o.g,o.h,o.l,i.i],styles:["ion-label[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%], p[_ngcontent-%COMP%]{margin-top:.75em}ion-item-option[_ngcontent-%COMP%]{font-size:1.5em}ion-item-sliding[_ngcontent-%COMP%]{cursor:pointer}"]}),e})();function S(e,t){if(1&e){const e=a.Nb();a.Mb(0,"app-session-item",6),a.Ub("delete",function(){a.bc(e);const n=t.$implicit;return a.Wb().deleteSession(n)})("selectItem",function(){a.bc(e);const n=t.$implicit;return a.Wb().launchSession(n)})("edit",function(){a.bc(e);const n=t.$implicit;return a.Wb().editSession(n)}),a.Lb()}if(2&e){const e=t.$implicit,n=a.Wb();let i=null;a.Zb("session",e)("selected",(null==(i=n.emulationService.getCurrentSession())?null:i.id)===e.id)}}const g=[{path:"",component:(()=>{class e{constructor(e,t,n,i,s){this.sessionService=e,this.fileService=t,this.alertController=n,this.emulationService=i,this.router=s}get sessions(){return this.sessionService.getSessions().sort((e,t)=>e.name.localeCompare(t.name))}deleteSession(e){return Object(c.a)(this,void 0,void 0,function*(){const t=yield this.alertController.create({header:"Warning",message:`Deleting the session '${e.name}' will remove all associated data. This cannot be undone. Are you sure you want to continue?`,buttons:[{text:"Cancel",role:"cancel"},{text:"Delete",handler:()=>this.sessionService.deleteSession(e)}]});yield t.present()})}editSession(e){return Object(c.a)(this,void 0,void 0,function*(){const t=yield this.queryName(e.name);void 0!==t&&this.sessionService.updateSession(Object.assign(Object.assign({},e),{name:t}))})}loadFile(){this.fileService.openFile(".img, .rom, .bin",this.processFile.bind(this))}launchSession(e){this.emulationService.switchSession(e.id),this.router.navigateByUrl("/tab/emulation")}processFile(e){return Object(c.a)(this,void 0,void 0,function*(){const t=this.fileService.parseSessionImage(e.content);if(t){const n=yield this.queryName(e.name);void 0!==n&&this.sessionService.addSessionFromImage(t,n)}else{const t=(yield this.emulationService.cloudpilot).getRomInfo(e.content);if(!t)return void this.errorMessage("Not a valid session file or ROM image.");if(0===t.supportedDevices.length)return void this.errorMessage("No supported device for this ROM.");const n=yield this.queryName(e.name);void 0!==n&&this.sessionService.addSessionFromRom(e.content,n,t.supportedDevices[0])}})}queryName(e){return new Promise(t=>Object(c.a)(this,void 0,void 0,function*(){(yield this.alertController.create({header:"Session Name",inputs:[{type:"textarea",name:"name",placeholder:"Session name",value:e,label:"Name"}],buttons:[{text:"Cancel",role:"cancel",handler:()=>t(void 0)},{text:"Continue",handler:e=>t(e.name)}]})).present()}))}errorMessage(e){return Object(c.a)(this,void 0,void 0,function*(){const t=yield this.alertController.create({header:"Error",message:e,buttons:[{text:"Close",role:"cancel"}]});yield t.present()})}}return e.\u0275fac=function(t){return new(t||e)(a.Jb(u),a.Jb(b),a.Jb(o.a),a.Jb(l.a),a.Jb(r.g))},e.\u0275cmp=a.Db({type:e,selectors:[["app-sessions"]],decls:14,vars:1,consts:[["slot","primary"],[3,"click"],["name","add-outline"],["collapse","condense"],["size","large"],[3,"session","selected","delete","selectItem","edit",4,"ngFor","ngForOf"],[3,"session","selected","delete","selectItem","edit"]],template:function(e,t){1&e&&(a.Mb(0,"ion-header"),a.Mb(1,"ion-toolbar"),a.Mb(2,"ion-title"),a.fc(3,"Sessions"),a.Lb(),a.Mb(4,"ion-buttons",0),a.Mb(5,"ion-button",1),a.Ub("click",function(){return t.loadFile()}),a.Kb(6,"ion-icon",2),a.Lb(),a.Lb(),a.Lb(),a.Lb(),a.Mb(7,"ion-content"),a.Mb(8,"ion-header",3),a.Mb(9,"ion-toolbar"),a.Mb(10,"ion-title",4),a.fc(11,"Sessions"),a.Lb(),a.Lb(),a.Lb(),a.Mb(12,"ion-list"),a.ec(13,S,1,2,"app-session-item",5),a.Lb(),a.Lb()),2&e&&(a.zb(13),a.Zb("ngForOf",t.sessions))},directives:[o.f,o.s,o.r,o.d,o.c,o.g,o.e,o.m,i.h,f],styles:[""]}),e})()}];let y=(()=>{class e{}return e.\u0275mod=a.Hb({type:e}),e.\u0275inj=a.Gb({factory:function(t){return new(t||e)},imports:[[r.i.forChild(g)],r.i]}),e})(),M=(()=>{class e{}return e.\u0275mod=a.Hb({type:e}),e.\u0275inj=a.Gb({factory:function(t){return new(t||e)},imports:[[i.b,s.a,o.t,y]]}),e})()}}]);